
<!DOCTYPE html>
<html>
<head>
    <title>Settings - Knights Templar Dashboard</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="/static/js/theme.js" defer></script>
</head>
<body>
    <div class="theme-switch-wrapper">
        <label class="theme-switch" for="theme-toggle">
            <input type="checkbox" id="theme-toggle" onchange="toggleTheme()" />
            <span class="slider"></span>
        </label>
        <span style="margin-left: 10px;">Dark Mode</span>
    </div>
    <div class="tab">
        <button class="tablinks" data-tab="Summary" onclick="openTab(event, 'Summary')">Summary</button>
        <button class="tablinks" data-tab="Nations" onclick="openTab(event, 'Nations')">Nations</button>
        <button class="tablinks" data-tab="CityTiers" onclick="openTab(event, 'CityTiers')">City Tiers</button>
        <button class="tablinks" data-tab="Military" onclick="openTab(event, 'Military')">Military</button>
        <button class="tablinks" data-tab="Resources" onclick="openTab(event, 'Resources')">Resources</button>
        <button class="tablinks" data-tab="OptimalBuild" onclick="openTab(event, 'OptimalBuild')">Optimal Build</button>
    </div>
    <div class="container">
        <div class="card">
            <div class="header">
                <h1>Knights Templar Dashboard Settings</h1>
            </div>
            
            <a href="/" class="btn">Back to Dashboard</a>
            
            {% if saved %}
            <div style="margin: 20px 0; padding: 10px; background-color: var(--income-color); color: white; border-radius: 4px;">
                Settings saved successfully!
            </div>
            {% endif %}
            
            <form method="post" action="/settings" style="margin-top: 20px;">
                <div style="margin-bottom: 20px;">
                    <label for="api_key" style="display: block; margin-bottom: 5px; font-weight: bold;">Politics & War API Key:</label>
                    <input type="text" id="api_key" name="api_key" value="{{ masked_key }}" 
                           style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--border-color); background-color: var(--card-bg); color: var(--text-color);">
                    <small style="display: block; margin-top: 5px;">Note: The API key is masked for security. Enter a new key to replace it.</small>
                </div>
                
                <button type="submit" class="btn btn-success">Save Settings</button>
            </form>
        </div>
    </div>
    <script>
    function openTab(evt, tabName) {
        // Hide all tab content
        var tabcontent = document.getElementsByClassName("tabcontent");
        for (var i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }
        
        // Remove active class from all tab buttons
        var tablinks = document.getElementsByClassName("tablinks");
        for (var i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }
        
        // Show the specific tab content
        document.getElementById(tabName).style.display = "block";
        
        // Add active class to the button that opened the tab
        evt.currentTarget.className += " active";
        
        // Initialize charts if needed
        if (tabName === 'CityTiers' && typeof initCityTiersChart === 'function') {
            initCityTiersChart();
        } else if (tabName === 'Military' && typeof initMilitaryChart === 'function') {
            initMilitaryChart();
        } else if (tabName === 'Resources' && typeof initResourceChart === 'function') {
            initResourceChart();
        }
        
        // Store the active tab in localStorage
        localStorage.setItem('activeTab', tabName);
        
        // Force a small delay then trigger a resize event to help charts render properly
        setTimeout(function() {
            window.dispatchEvent(new Event('resize'));
        }, 10);
    }

    // On page load, set up all event listeners
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize collapsible sections
        var coll = document.getElementsByClassName("collapsible");
        for (var i = 0; i < coll.length; i++) {
            coll[i].addEventListener("click", function() {
                this.classList.toggle("active");
                var content = this.nextElementSibling;
                if (content.style.maxHeight) {
                    content.style.maxHeight = null;
                } else {
                    content.style.maxHeight = content.scrollHeight + "px";
                }
            });
        }
        
        // Set up the tab that was active before page refresh
        var activeTab = localStorage.getItem('activeTab');
        if (activeTab) {
            // Find the tab button and click it
            var tablinks = document.getElementsByClassName("tablinks");
            for (var i = 0; i < tablinks.length; i++) {
                if (tablinks[i].textContent.trim() === activeTab.trim() || 
                    tablinks[i].getAttribute('data-tab') === activeTab) {
                    tablinks[i].click();
                    return;
                }
            }
        }
        
        // If no active tab found or stored, default to first tab
        document.querySelector('.tablinks').click();
    });

    // For MMR selector
    function changeMmrType(mmrType) {
        window.location.href = '/change_mmr/' + mmrType;
    }

    // Fix dark mode toggle
    if (typeof toggleTheme !== 'function') {
        function toggleTheme() {
            const body = document.body;
            body.classList.toggle('dark-mode');
            
            // Save preference to localStorage
            const darkMode = body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', darkMode);
            
            // Update charts if they exist
            if (typeof updateChartsTheme === 'function') {
                updateChartsTheme();
            }
        }
        
        // Apply saved theme on load
        const darkMode = localStorage.getItem('darkMode') === 'true';
        if (darkMode) {
            document.body.classList.add('dark-mode');
            const toggle = document.getElementById('theme-toggle');
            if (toggle) toggle.checked = true;
        }
    }
    </script>
</body>
</html>
